package com.lyncwork.services.hellosign.client.dropbox.config;

import feign.RequestInterceptor;
import feign.codec.Decoder;
import feign.codec.Encoder;
import feign.form.FormEncoder;
import feign.jackson.JacksonDecoder;
import org.springframework.beans.factory.ObjectFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.http.HttpMessageConverters;
import org.springframework.cloud.openfeign.support.SpringEncoder;
import org.springframework.context.annotation.Bean;

import java.util.Base64;

public class AuthConfig  {

    @Value("${dropbox.app_key}")
    private String appKey;

    @Value("${dropbox.app_secret}")
    private String appSecret;

    @Autowired
    private String basic;

    @Bean
    public Encoder feignFormEncoder(ObjectFactory<HttpMessageConverters> messageConverters) {
        return new FormEncoder(new SpringEncoder(messageConverters));
    }

    @Bean
    public Decoder feignDecoder() {
        return new JacksonDecoder();
    }

    @Bean
    public RequestInterceptor requestInterceptor() {
        return requestTemplate -> {
            requestTemplate.header("Authorization", "Basic " + basic);
        };
    }

    @Bean
    private String basic() {
        java.util.Base64.Encoder encode = Base64.getEncoder();
        String appKeySecret = new StringBuffer().append(appKey).append(":").append(appSecret).toString();
        byte[] encoded = encode.encode(appKeySecret.getBytes());
        String key = new String(encoded);
        return key;
    }
}

