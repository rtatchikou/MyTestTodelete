package com.lyncwork.services.expensify.client.expensify.controller;


import com.google.api.client.json.JsonFactory;
import com.google.api.client.json.jackson2.JacksonFactory;
import com.lyncwork.services.expensify.client.expensify.client.ExpensifyClient;
import com.lyncwork.services.expensify.client.expensify.interceptor.ExpensifyClientInterceptor;
import com.lyncwork.services.expensify.client.expensify.payload.Company;
import com.lyncwork.services.expensify.client.expensify.service.ExpensifyService;
import com.lyncwork.services.expensify.client.expensify.service.Processor.ExpensifyProcessor;
import com.lyncwork.services.expensify.client.store.client.SubscriptionAppClient;
import com.lyncwork.services.expensify.processors.Constants;
import com.lyncwork.services.expensify.repository.hibernate.TenantContext;

import org.apache.http.client.utils.URIBuilder;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.thymeleaf.util.StringUtils;

import java.io.IOException;
import java.net.URI;
import java.util.*;

@RestController
public class ExpensifyResource {

    private static final Logger logger = LoggerFactory.getLogger(ExpensifyResource.class);
    private static final JsonFactory JSON_FACTORY = JacksonFactory.getDefaultInstance();

    @Autowired
    ExpensifyService expensifyService;
    @Autowired
    SubscriptionAppClient subscriptionAppClient;
    @Autowired
    ExpensifyClient expensifyClient;
    @Autowired
    ExpensifyProcessor expensifyProcessor;
    @Value("${expensify.oauth.autorize.url}")
    String expensifyAutorizeUrl;
    @Value("${lyncworks.domain}")
    private String domain;
    @Autowired
    ExpensifyClientInterceptor interceptor;
    @RequestMapping("/login/expensify/{tenantId}")
    public ResponseEntity<Void> expensifyConnectionStatus(@PathVariable String tenantId) throws Exception {
    	ExpensifyService.ExpensifyParameters expensifyParameters = expensifyService.getExpensifyParameters();
        Map<String, Object> frontEndUrlMap =new HashMap<>();
        if (!StringUtils.isEmpty(TenantContext.getFrontendDomain())){
            frontEndUrlMap.put(Constants.EXPENSIFY_FRONTEND_REDIRECT_URL,TenantContext.getFrontendDomain());
        } else {
            String scheme = TenantContext.getRefererScheme().isEmpty() ? "http" : TenantContext.getRefererScheme().get();

            frontEndUrlMap.put("frontend-redirect-url",(String.format("%s://%s.%s", scheme, tenantId, domain)));
        }
        expensifyService.saveExpensifyProperties(frontEndUrlMap);
        URI uri = new URIBuilder(expensifyAutorizeUrl).addParameter(Constants.EXPENSIFY_CLIENT_ID, expensifyParameters.getClientId())
            .addParameter(Constants.EXPENSIFY_REDIRECT_URI, expensifyParameters.getRedirectUri())
            .addParameter(Constants.EXPENSIFY_RESPONSE_TYPE, "code").build();
        return ResponseEntity.status(HttpStatus.TEMPORARY_REDIRECT)
            .header(HttpHeaders.LOCATION, uri.toString())
            .build();
    }

    @GetMapping("redirect/Expensify")
    public ResponseEntity<String> oauth2Callback(@RequestParam(value = "code") String code) throws IOException {
    	ExpensifyService.ExpensifyParameters gustoParameters = expensifyService.getExpensifyParameters();
        logger.info(gustoParameters.toString());
        Map<String, Object> responseCode = expensifyClient.getAccessToken(
            gustoParameters.getClientId(),
            gustoParameters.getRedirectUri(),
            gustoParameters.getClientSecret(),
            Constants.EXPENSIFY_AUTHORIZATION_CODE, code);
        String message;
        if (responseCode != null) {
            try {
                String accessToken = (String) responseCode.get(Constants.EXPENSIFY_ACCESS_TOKEN);
                List<Company> companies = expensifyClient.getCompanyID(Constants.BEARER + " " + accessToken);
                if (companies != null)
                    responseCode.put(Constants.EXPENSIFY_COMPANY_ID, companies.get(0).getId());
                message = expensifyService.saveExpensifyProperties(responseCode);
            }catch (Exception e) {
                logger.error(e.getMessage(), e);
                logger.error("Exception while handling OAuth2 callback ({}). Redirecting to google connection status page.", e.getMessage());
                message = "Exception while handling OAuth2 callback (" + e.getMessage() + "). Redirecting to google connection status page.";
            }

            logger.debug("Response message: {}", message);
            return  ResponseEntity.status(HttpStatus.FOUND)
                .header(HttpHeaders.LOCATION, expensifyParameters.getFrontendRedirectUrl())
                .build();
        }
        return null;
    }

}
